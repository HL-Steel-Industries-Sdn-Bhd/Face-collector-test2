<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Register</title>
<!-- 使用支持浏览器的版本 -->
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body { font-family: Arial; text-align: center; margin-top: 30px; }
#video { width: 300px; border-radius: 10px; }
#output { width: 90%; height: 200px; margin: 10px 0; }
#status { color: #666; margin: 10px 0; }
.loading { color: blue; }
.success { color: green; }
.error { color: red; }
canvas { position: absolute; top: 0; left: 0; z-index: 10; }
.video-container { position: relative; display: inline-block; }
</style>
</head>
<body>

<h2>Face Recognition</h2>
<div class="video-container">
    <video id="video" width="640" height="480" autoplay muted></video>
</div><br>
<div id="status" class="loading">正在加载 face-api.js 库...</div>
<button id="snap" disabled> Generate Embedding</button>

<h3>Embedding Copy </h3>
<textarea id="output" readonly></textarea>
<br>
<button id="copyBtn" disabled>Copy Embedding</button>

<script>
// 全局变量
let modelsLoaded = false;

// DOM 元素引用
const videoElement = document.getElementById('video');
const statusEl = document.getElementById('status');
const snapBtn = document.getElementById('snap');
const outputEl = document.getElementById('output');
const copyBtn = document.getElementById('copyBtn');

// 设置按钮点击事件 - 使用函数引用
snapBtn.onclick = captureFace;
copyBtn.onclick = copyToClipboard;

// 页面加载后执行
window.addEventListener('load', async () => {
    try {
        // 检查 faceapi 是否已加载
        await checkFaceAPI();
        
        // 启动摄像头
        await startCamera();
        
        // 加载模型
        await loadModels();
        
        modelsLoaded = true;
        snapBtn.disabled = false;
        statusEl.textContent = '✓ Ready to take photo';
        statusEl.className = 'success';
        
        console.log('初始化完成，modelsLoaded:', modelsLoaded);
        
    } catch (error) {
        console.error('初始化失败:', error);
        statusEl.textContent = '初始化失败: ' + error.message;
        statusEl.className = 'error';
    }
});

// 检查 faceapi 是否加载
function checkFaceAPI() {
    return new Promise((resolve, reject) => {
        if (window.faceapi) {
            console.log('faceapi 已加载:', faceapi);
            resolve();
            return;
        }
        
        let attempts = 0;
        const maxAttempts = 30;
        const interval = setInterval(() => {
            attempts++;
            if (window.faceapi) {
                clearInterval(interval);
                console.log('faceapi 加载成功');
                resolve();
            } else if (attempts >= maxAttempts) {
                clearInterval(interval);
                reject(new Error('face-api.js 加载超时'));
            }
        }, 100);
    });
}

// 启动摄像头
async function startCamera() {
    try {
        statusEl.textContent = '正在请求摄像头权限...';
        statusEl.className = 'loading';
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: 640, 
                height: 480,
                facingMode: "user" 
            } 
        });
        
        videoElement.srcObject = stream;
        
        return new Promise((resolve) => {
            videoElement.onloadedmetadata = () => {
                videoElement.play();
                console.log('摄像头启动，视频尺寸:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                statusEl.textContent = '摄像头已就绪';
                resolve();
            };
        });
    } catch (error) {
        console.error('摄像头错误:', error);
        throw new Error('无法访问摄像头: ' + error.message);
    }
}

// 加载模型
async function loadModels() {
    try {
        statusEl.textContent = 'Loading';
        statusEl.className = 'loading';
        
        // 使用正确的模型路径
        const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
        
        console.log('开始加载模型...');
        
        // 加载所需模型
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        console.log('tinyFaceDetector 加载完成');
        
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        console.log('faceLandmark68Net 加载完成');
        
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        console.log('faceRecognitionNet 加载完成');
        
        console.log('所有模型加载成功');
        
    } catch (error) {
        console.error('模型加载失败:', error);
        throw new Error('模型加载失败: ' + error.message);
    }
}

// 拍照按钮事件处理函数
async function captureFace() {
    if (!modelsLoaded) {
        alert('模型还未加载完成，请稍候...');
        return;
    }
    
    try {
        statusEl.textContent = '正在检测人脸...';
        statusEl.className = 'loading';
        snapBtn.disabled = true;
        
        console.log('开始人脸检测...');
        console.log('video readyState:', videoElement.readyState);
        console.log('video尺寸:', videoElement.videoWidth, 'x', videoElement.videoHeight);
        
        // 确保视频已就绪
        if (videoElement.readyState < 2) {
            throw new Error('视频未就绪，请等待摄像头初始化');
        }
        
        // 修正：正确实例化 TinyFaceDetectorOptions
        const options = new faceapi.TinyFaceDetectorOptions({
            inputSize: 320,
            scoreThreshold: 0.5
        });
        
        console.log('使用检测选项:', options);
        
        // 检测人脸 - 使用正确的语法
        const detection = await faceapi
            .detectSingleFace(videoElement, options)
            .withFaceLandmarks()
            .withFaceDescriptor();

        console.log('检测结果:', detection);
        
        if (!detection) {
            throw new Error('未检测到人脸');
        }
        
        console.log('检测到人脸，分数:', detection.detection.score);
        
        // 获取 embedding
        const emb = Array.from(detection.descriptor);
        console.log('embedding长度:', emb.length);
        
        // 显示结果
        outputEl.value = JSON.stringify({
            name: "TEST_USER",
            timestamp: new Date().toISOString(),
            embedding_size: emb.length,
            embedding: emb
        }, null, 2);
        
        // 启用复制按钮
        copyBtn.disabled = false;
        
        statusEl.textContent = '✓ Embedding Successfully Generated！';
        statusEl.className = 'success';
        
        // 绘制检测结果
        displayDetection(detection);
        
        alert("✓ Embedding Generated！\nDetected Human Face，embedding length " + emb.length);
        
    } catch (error) {
        console.error('检测错误:', error);
        statusEl.textContent = '检测失败: ' + error.message;
        statusEl.className = 'error';
        alert("检测失败:\n" + error.message + "\n\n请确保：\n1. 面部清晰可见\n2. 光线充足\n3. 摄像头正常工作");
    } finally {
        snapBtn.disabled = false;
    }
}

// 复制到剪贴板
function copyToClipboard() {
    if (!outputEl.value) {
        alert("没有可复制的内容，请先生成 embedding");
        return;
    }
    
    outputEl.select();
    document.execCommand('copy');
    alert("Copied to clipboard！");
}

// 显示检测框
function displayDetection(detection) {
    // 移除之前的canvas
    const oldCanvas = document.querySelector('canvas');
    if (oldCanvas) oldCanvas.remove();
    
    // 创建canvas
    const canvas = faceapi.createCanvasFromMedia(videoElement);
    const container = document.querySelector('.video-container');
    container.appendChild(canvas);
    
    // 匹配尺寸
    const displaySize = { width: videoElement.width, height: videoElement.height };
    faceapi.matchDimensions(canvas, displaySize);
    
    // 调整检测结果尺寸
    const resizedDetection = faceapi.resizeResults(detection, displaySize);
    
    // 绘制
    faceapi.draw.drawDetections(canvas, [resizedDetection]);
    faceapi.draw.drawFaceLandmarks(canvas, [resizedDetection]);
    
    // 3秒后移除canvas
    setTimeout(() => {
        if (canvas.parentNode === container) {
            canvas.remove();
        }
    }, 3000);
}

// 添加错误监听
window.addEventListener('error', (e) => {
    console.error('全局错误:', e.error);
    if (statusEl) {
        statusEl.textContent = '发生错误: ' + e.message;
        statusEl.className = 'error';
    }
});

// 添加页面卸载时的清理
window.addEventListener('beforeunload', () => {
    if (videoElement.srcObject) {
        const tracks = videoElement.srcObject.getTracks();
        tracks.forEach(track => track.stop());
    }
});
</script>

</body>
</html>
